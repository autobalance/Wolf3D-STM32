source [find interface/stlink.cfg]

transport select hla_swd

set QUADSPI 1

source [find target/stm32h7x_dual_bank.cfg]

reset_config none


proc qspi_init { } {
	mmw 0x580244E0 0x0000001A 0				;# RCC_AHB4ENR |= GPIOB,GPIOD,GPIOE (enable clocks)
	mmw 0x580244D4 0x00004000 0				;# RCC_AHB3ENR |= QSPIEN (enable clock)
	sleep 1									;# Wait for clock startup
	# PB06: BK1_NCS, PB02: CLK, PD13: BK1_IO3, PE2: BK1_IO2, PD12: BK1_IO1, PD11: BK1_IO0
	# PB06:AF10:V, PB02:AF09:V, PC11:AF09:V, PD13:AF09:V, PD12:AF09:V, PD11:AF09:V
	# Port B: PB06:AF10:V, PB02:AF09:V
	mmw 0x58020400 0x00002020 0x00001010    ;# MODER
	mmw 0x58020408 0x00003030 0x00000000    ;# OSPEEDR
	mmw 0x58020420 0x0A000900 0x05000600    ;# AFRL
	# Port D: PD13:AF09:V, PD12:AF09:V, PD11:AF09:V
	mmw 0x58020C00 0x0A800000 0x05400000    ;# MODER
	mmw 0x58020C08 0x0FC00000 0x00000000    ;# OSPEEDR
	mmw 0x58020C24 0x00999000 0x00666000    ;# AFRH
	# Port E: PE02:AF09:V
	mmw 0x58021000 0x00000020 0x00000010    ;# MODER
	mmw 0x58021008 0x00000030 0x00000000    ;# OSPEEDR
	mmw 0x58021020 0x00000900 0x00000600    ;# AFRL

	# correct FSIZE would be 0x16, however, this causes trouble when
	# reading the last word at end of bank in memory mapped mode
	# for w25q64jv
	mww 0x52005000 0x04000010			    ;# QUADSPI_CR: PRESCALER=4, FTHRES=0, SSHIFT=1
	mww 0x52005004 0x00160100			    ;# QUADSPI_DCR: FSIZE=0x16, CSHT=0x01, CKMODE=0

	mww 0x52005014 0x0D002503				;# QUADSPI_CCR: FMODE=0x3, DMODE=0x1, DCYC=0x0, ADSIZE=0x2, ADMODE=0x1, IMODE=0x1
	mmw 0x52005000 0x00000001 0				;# QUADSPI_CR: EN=1
}

$_CHIPNAME.cpu0 configure -event reset-init {
	global QUADSPI
	mww 0x52002000 0x00000034				;# FLASH_ACR: 4 WS for 192 MHZ HCLK
	mmw 0x58024400 0x00000001 0x00000018	;# RCC_CR: HSIDIV=1, HSI on
	mmw 0x58024410 0x10000000 0xEE000007	;# RCC_CFGR: MCO2=system, MCO2PRE=8, HSI as system clock
	mww 0x58024418 0x00000040				;# RCC_D1CFGR: D1CPRE=1, D1PRE=1, HPRE=1
	mww 0x5802441C 0x00000440				;# RCC_D2CFGR: D2PRE2=2, D2PRE1=2
	mww 0x58024420 0x00000040				;# RCC_D3CFGR: D3PRE=2
	mww 0x58024428 0x00000040				;# RCC_PPLCKSELR: DIVM3=0, DIVM2=0, DIVM1=4, PLLSRC=HSI
	mmw 0x5802442C 0x0001000C 0x00000002	;# RCC_PLLCFGR: PLL1RGE=8MHz to 16MHz, PLL1VCOSEL=wide
	mww 0x58024430 0x01070217				;# RCC_PLL1DIVR: 192 MHz: DIVR1=2, DIVQ=8, DIVP1=2, DIVN1=24
	mmw 0x58024400 0x01000000 0				;# RCC_CR: PLL1ON=1
	sleep 1
	mmw 0x58024410 0x00000003 0				;# RCC_CFGR: PLL1 as system clock
	sleep 1
	adapter speed 1800
	if { $QUADSPI } {
		qspi_init
	}
}
